<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>13. Bonus: Creating an article layout</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <article>
        <h1 id="running-any-npm-package-in-the-browser-locally">Running any npm package in the browser locally</h1>

        <p>
            JavaScript has never had any official solution for distributing
            packages, and every web platform (Rails, Django etc) has their own idea
            of how to structure and package JavaScript. In the last few years NPM
            has started becoming the canonical way of distribution, with Webpack as
            the build system, but there's no way to load NPM packages in the browser
            without a server-side component.
        </p>

        <p>
            Scrimba is a platform for interactive coding screencast where you can
            run the code at any moment in time. Being able to use NPM packages has
            been a frequently requested feature, but it turns out to be surprisingly
            technically dificult to implement. In this article I will explain how
            we tackled the problem and the final solution we ended up with.
        </p>

        <figure>
            <img src="https://mave.me/img/projects/full_placeholder.png" alt="">
            <figcaption>Credits: Wesley Buurke</figcaption>
        </figure>

        <p>
            Our solution (inspired by StackBlitz) runs almost entirely on the
            client-side. Dependency resolution is done server-side, but
            fetching NPM files, parsing <code>require()</code>, resolving require paths and
            creating a bundle is all done at the client. This (combined with
            IndexedDB caching) gives a smooth experience with very low latency.
        </p>

        <h2 id="what-is-involved-in-supporting-npm">What is involved in supporting NPM?</h2>

        <p>
            There are two very distinct steps in supporting NPM: Dependency
            resolution and module loading.
        </p>

        <p><strong>Dependency resolution</strong> is about going from a dependency requirement,</p>

        <div class="language-json highlighter-coderay">
            <div class="CodeRay">
                <div class="code">
                    <pre>
<span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color: #606;"><span style="color: #404;">&quot;</span><span>dependencies</span><span style="color: #404;">&quot;</span></span>: {
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color: #606;"><span style="color: #404;">&quot;</span><span>react</span><span style="color: #404;">&quot;</span></span>: <span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">^16.0.0</span><span style="color: #710;">&quot;</span></span>,
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  <span style="color: #606;"><span style="color: #404;">&quot;</span><span>react-rom</span><span style="color: #404;">&quot;</span></span>: <span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">^16.0.0</span><span style="color: #710;">&quot;</span></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span> }
                    </pre>
                </div>
            </div>
        </div>

        <p>to a concrete description of what packages needs to be installed:</p>

        <pre><code>
node_modules/react  react@16.o.o
node_modules/react-dom  react-dom@16.0.0
node_modules/fbjs   fbjs@16.0.0
...
        </code></pre>

        <p><strong>Module loading</strong> is more involved and includes:</p>

        <ul>
            <li>Figuring out that <code>require("react")</code>in app.js refers to node_modules/react/index.js</li>
            <li>Making sure dependencies are available before the module body is being executed</li>
            <li>Providing <code>exports</code>, <code>module</code>, <code>process</code> variables inside the module body</li>
        </ul>

        <h2 id="dependency-resolution">Dependency resolution</h2>

        <p>
            <a href="https://yarnpkg.com">Yarn</a> is a package manager for NPM which you
            <em>can</em> use a library. There is not a public API available at the moment,
            but as longas you depend on a fixed version everything works out nicely. Yarn
            has a <code>PackageResolver</code> which resolves all dependencies, and with the
            <code>PackageHoister</code> you can find the paths where packages needs to be
            installed. Yarn is decently decoupled and although it lacks documentation about
            the internal classes it's quite easy to figure things out.
        </p>

        <h2 id="module-loader-webpack">Module loader: Webpack</h2>

        <p>
            There are some online coding sandboxes (<a href="https://www.webpackbin.com/">Webpackbin</a>
            and <a href="https://codesandbox.io/">CodeSandbox</a>) which supports NPM packages through
            server-side Webpack. Their approach is essentially as follows:
        </p>

        <p>
            First they have a <em>packager</em> which takes a list of fully resolved packages
            (e.g <code>react@16.0.0, react-dom@16.0.0</code>), generates a <code>package.json</code>,
            install packages and dependencies with <code>yarn</code>, and then uses Webpack to build
            a <a href="https://webpack.js.org/plugins/dll-plugin">DLL package</a>. A DLL package is
            a way of building all files into a single Webpack bundle. Packaging can take a while
            (&gt;10s), but it's only needed once per request and you can cache the produced package
            indefinitely.
        </p>

        <p>
            When you want to execute your app.js you send it to the server, generate a Webpack configuration
            (which includes a reference to the DLL package) and Webpack will resolve everything for you.
        </p>

        <p>There are two big disadvantages with this approach:</p>

        <ul>
            <li>
                Building the initial package can take a long time. This needs to be done on the server-side
                and its scalability is limited by how many servers you have.
            </li>
            <li>
                Packages can only be cached as whole. This means that if you add one small dependency you
                must still create a whole new package.
            </li>
        </ul>

        <p>
            We created a prototype tohether with Christian Alfoni (the creator of Webpackbin), but had some
            pending work when we discovereda different approach.
        </p>

        <h2 id="module-loader-unpkg--systemjs">Module loader: Unpkg + SystemJS</h2>

        <p>
            <a href="https://stackblitz.com">StackBlitz</a> is an online coding sandbox which supports NPM without
            using Webpack at all. They briefly described their approach in a
            <a href="https://github.com/unpkg/unpkg-website/issues/35#issuecomment-317128917">comment at the unpkg-repo</a>:
        </p>

        <blockquote>
            <p>
                In short, SystemJS &amp; Unpkg are an incredible duo for dev UX because they reflect what makes local
                dev environments great: the client is doing of the downloading, installing, bundling, and even serving
                the application.
            </p>
        </blockquote>

        <p>
            They haven't open-sourced their solution yet, but from their description we can still go through how it
            works. Let's say we have an app.js which contains the following:
        </p>

        <div class="language-javascript highlighter-coderay">
            <div class="CodeRay">
                <div class="code">
                    <pre>
<span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color: #080; font-weight: bold;">import</span> React from <span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">'</span><span style="color: #d20;">react</span><span style="color: #710;">'</span></span>;
<span class="line-numbers"><a href="#n2" name="n2">2</a></span><span style="color: #080; font-weight: bold;">import</span> ReactDOM from <span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">'</span><span style="color: #d20;">react-dom</span><span style="color: #710;">'</span></span>;
                    </pre>
                </div>
            </div>
        </div>

        <p>
            This can be defined as a module in SystemJS and it will start doing its magic. The required paths
            (<code>react</code> and <code>react-dom</code>) will be extracted and attempted resolved. By writing
            a SystemJS-plugin we can integrate with <a href="https://unpkg.com">Unpkg</a> and fetch files directly
            from NPM packages:
        </p>

        <ul>
            <li>
                First we can load <a href="https://unpkg.com/react@16.0.0/package.json">https://unpkg.com/react@16.0.0/package.json</a>
                to find the main file. In this case it's index.
            </li>
            <li>
                Then we can fetch <a href="https://unpkg.com/react@16.0.0/index.js">https://unpkg.com/react@16.0.0/index.json</a>
                directly and register it as a SystemJS module.
            </li>
            <li>
                SystemJS will extract the required paths from this file and recursively fetch/register all dependent files.
            </li>
            <li>
                Once everything is complete we can execute our original app.js.
            </li>
        </ul>

        <p>
            From StackBlitz' description we implemented a prototype in Scrimba, and we had the following experiences:
        </p>

        <ul>
            <li>
                It turns out that SystemJS's built-in resolve logic doesn't completely match Node's, and there's quite
                a few packages which depends on Node's behaviour. We ended up writing our custom path resolver.
            </li>
            <li>
                SystemJS is slow. Even though we cached the content of the files and did no HTTP requests at all,
                it took around 150ms to just resolve all dependencies. It seems to be caused by heavily use of
                Promises which causes overhead when there's no asynchronity.
            </li>
        </ul>

        <p>
            In the end we felt we needed to re-invent many parts of SystemJS in order to get the correct behaviour,
            and the parts left of SystemJS were slow or not in use.
        </p>

        <h2 id="module-loader-custom-loader-our-approach">Module loader: Custom loader(our approach)</h2>

        <p>
            Our final solution uses a module loader we wrote for our use case. It consists of several decoupled
            parts which combines into a complete solution. The project is called "mrmanager" and is currently
            not open-sourced, but if there's interest we can make it happen.
        </p>

        <p>
            First there's a virtual file system. The file system handles require path resolution and integrates
            with Unpkg to fetch NPM files.
        </p>

        <div class="language-javascript highlighter-coderay">
            <div class="CodeRay">
                <div class="code">
                    <pre>
<span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color: #080; font-weight: bold;">var</span> fs = <span style="color: #080; font-weight: bold;">new</span> FileSystem;
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span><span style="color: #777;">// Set up file system:</span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span><span style="color: #080; font-weight: bold;">var</span> npm = <span style="color: #080; font-weight: bold;">new</span> PackageSet;
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>fs.mount(<span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">/node_modules/react/</span><span style="color: #710;">&quot;</span></span>), npm.get(<span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">react@16.0.0</span><span style="color: #710;">&quot;</span></span>);
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>fs.mount(<span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">/node_modules/react-dom/</span><span style="color: #710;">&quot;</span></span>), npm.get(<span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">react-dom@16.0.0</span><span style="color: #710;">&quot;</span></span>);
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>
<span class="line-numbers"><a href="#n8" name="n8">8</a></span><span style="color: #080; font-weight: bold;">var static</span> = <span style="color: #080; font-weight: bold;">new</span> StaticMount({<span style="color: #606;"><span style="color: #404;">&quot;</span><span>app.js</span><span style="color: #404;">&quot;</span></span>}: <span style="background-color: hsla(0, 100%, 50%, 0.05);"><span style="color: #710;">&quot;</span><span style="color: #d20;">require('react')</span><span style="color: #710;">&quot;</span></span>)

                    </pre>
                </div>
            </div>
        </div>

    </article>
</body>

</html>